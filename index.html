<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>NFT Биржа</title>
  <style>
    body { background: #e6f0fa; font-family: sans-serif; color: #000; margin:0; padding:0; }
    header {
      background: #0077cc;
      color: #fff;
      padding: 15px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      position: relative;
    }
    #profileBtn {
      position: absolute;
      left: 10px;
      top: 15px;
      background: #005fa3;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    #profileBtn:hover {
      background: #00457a;
    }
    #userInfo {
      margin-top: 8px;
      font-size: 16px;
    }
    #loginBox {
      max-width: 320px;
      margin: 30px auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #999;
      text-align: center;
    }
    #loginBox input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      box-sizing: border-box;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    #loginBox button {
      width: 100%;
      padding: 14px;
      font-size: 18px;
      background: #0077cc;
      border: none;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 12px;
    }
    #loginBox button:hover {
      background: #005fa3;
    }
    .container {
      padding: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 10px;
      width: 220px;
      box-shadow: 0 0 5px #aaa;
      text-align: center;
      user-select: none;
    }
    .card img {
      width: 100%;
      border-radius: 6px;
    }
    .card button {
      margin-top: 10px;
      background: #0077cc;
      border: none;
      color: white;
      padding: 8px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      width: 100%;
    }
    .card button:hover {
      background: #005fa3;
    }
    #profilePanel {
      display: none;
      max-width: 400px;
      margin: 20px auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 0 15px #666;
      padding: 20px;
    }
    #profilePanel h2 {
      margin-top: 0;
      text-align: center;
    }
    #profilePanel button {
      background: #cc0000;
      color: white;
      border: none;
      padding: 10px;
      margin-top: 10px;
      width: 100%;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
    }
    #profilePanel button:hover {
      background: #990000;
    }
    #chatBox {
      max-width: 400px;
      margin: 20px auto;
      background: #fff;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 0 10px #555;
      display: none;
    }
    #chatMessages {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      background: #f9f9f9;
    }
    #chatMessages div {
      margin-bottom: 8px;
      padding: 5px 10px;
      border-radius: 10px;
    }
    #chatMessages .me {
      background: #0077cc;
      color: white;
      text-align: right;
    }
    #chatMessages .other {
      background: #ddd;
      color: black;
      text-align: left;
    }
    #chatControls select, #chatControls input, #chatControls button {
      padding: 8px;
      font-size: 14px;
      margin-bottom: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
    }
    #chatControls button {
      background: #0077cc;
      color: white;
      border: none;
      cursor: pointer;
    }
    #chatControls button:hover {
      background: #005fa3;
    }
    #telegramFooter {
      text-align: center;
      margin: 30px 0 15px;
    }
    #telegramFooter img {
      width: 150px;
      cursor: pointer;
      opacity: 0.85;
      transition: opacity 0.3s ease;
    }
    #telegramFooter img:hover {
      opacity: 1;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getDatabase, ref, get, set, onValue, push } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAAgeGGJAqYjQf0B8W_K7OX01aoriYeULo",
      authDomain: "nft-birga.firebaseapp.com",
      databaseURL: "https://nft-birga-default-rtdb.firebaseio.com/",
      projectId: "nft-birga",
      storageBucket: "nft-birga.appspot.com",
      messagingSenderId: "387414090259",
      appId: "1:387414090259:web:8342f9a11174433dc895e6",
      measurementId: "G-2Q5WNT0VGQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentUser = null;

    async function loginUser() {
      const loginInput = document.getElementById('login');
      const passwordInput = document.getElementById('password');
      const login = loginInput.value.trim();
      const password = passwordInput.value.trim();

      if (!login || !password) {
        alert('Введите логин и пароль');
        return;
      }

      try {
        const usersSnap = await get(ref(db, 'users'));
        let usersObj = usersSnap.val() || {};

        if (!usersObj[login]) {
          // Регистрация нового пользователя
          usersObj[login] = { password, balance: 0 };
          await set(ref(db, 'users'), usersObj);
        } else {
          // Проверка пароля
          if (usersObj[login].password !== password) {
            alert('Неверный пароль');
            return;
          }
        }

        currentUser = login;
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('container').style.display = 'flex';
        document.getElementById('profileBtn').style.display = 'inline-block';
        document.getElementById('userInfo').innerText = `Пользователь: ${currentUser}`;

        loginInput.value = '';
        passwordInput.value = '';

        renderNFTs();
        renderProfile();
        loadChatUsers();
        document.getElementById('chatBox').style.display = 'block';

      } catch (e) {
        alert('Ошибка при входе');
        console.error(e);
      }
    }

    function logoutUser() {
      currentUser = null;
      document.getElementById('loginBox').style.display = 'block';
      document.getElementById('container').style.display = 'none';
      document.getElementById('profileBtn').style.display = 'none';
      document.getElementById('profilePanel').style.display = 'none';
      document.getElementById('chatBox').style.display = 'none';
      document.getElementById('userInfo').innerText = '';
    }

    async function renderNFTs() {
      try {
        const nftsSnap = await get(ref(db, 'nfts'));
        const nftsObj = nftsSnap.val() || {};
        const nfts = Object.values(nftsObj);

        const container = document.getElementById('container');
        container.innerHTML = '';

        nfts.forEach(nft => {
          const div = document.createElement('div');
          div.className = 'card';
          div.innerHTML = `
            <img src="${nft.image}" alt="NFT" />
            <h3>${nft.title}</h3>
            <p>Код: ${nft.code}</p>
            <p>Редкость: ${nft.rarity}</p>
            <p>Владелец: ${nft.owner}</p>
            <p>Цена: ${nft.price} STAR</p>
            ${
              nft.owner === currentUser && !nft.forSale
                ? `<button onclick="sellNFT('${nft.id}')">Продать</button>`
                : nft.forSale && nft.owner !== currentUser
                ? `<button onclick="buyNFT('${nft.id}')">Купить</button>`
                : ''
            }
          `;
          container.appendChild(div);
        });
      } catch (e) {
        console.error('Ошибка загрузки NFT:', e);
      }
    }

    async function sellNFT(id) {
      if (!currentUser) return alert('Войдите в аккаунт');

      try {
        const nftRef = ref(db, 'nfts/' + id);
        const nftSnap = await get(nftRef);
        const nft = nftSnap.val();

        if (nft.owner !== currentUser) {
          alert('Вы не владелец этого NFT');
          return;
        }

        let price = prompt('Введите цену продажи (>= 0)', nft.price);
        price = parseFloat(price);
        if (isNaN(price) || price < 0) {
          alert('Неверная цена');
          return;
        }

        await set(nftRef, {...nft, forSale: true, price});

        alert('NFT выставлен на продажу');
        renderNFTs();
      } catch (e) {
        alert('Ошибка выставления на продажу');
        console.error(e);
      }
    }

    async function buyNFT(id) {
      if (!currentUser) return alert('Войдите в аккаунт');

      try {
        const nftRef = ref(db, 'nfts/' + id);
        const nftSnap = await get(nftRef);
        const nft = nftSnap.val();

        if (!nft.forSale) {
          alert('Этот NFT не продаётся');
          return;
        }
        if (nft.owner === currentUser) {
          alert('Вы уже владеете этим NFT');
          return;
        }

        const usersSnap = await get(ref(db, 'users'));
        const usersObj = usersSnap.val() || {};

        if (!usersObj[currentUser]) {
          alert('Пользователь не найден');
          return;
        }
        if ((usersObj[currentUser].balance || 0) < nft.price) {
          alert('Недостаточно средств');
          return;
        }

        // Перевод средств
        usersObj[currentUser].balance -= nft.price;
        if (!usersObj[nft.owner]) {
          usersObj[nft.owner] = { password: '', balance: 0 };
        }
        usersObj[nft.owner].balance += nft.price;

        await set(ref(db, 'users'), usersObj);

        // Перепродажа NFT
        await set(nftRef, {...nft, owner: currentUser, forSale: false});

        alert('Покупка прошла успешно!');
        renderNFTs();
        renderProfile();

      } catch (e) {
        alert('Ошибка покупки NFT');
        console.error(e);
      }
    }

    // Профиль
    async function renderProfile() {
      if (!currentUser) return;

      const usersSnap = await get(ref(db, 'users/' + currentUser));
      const user = usersSnap.val() || {};
      const balance = user.balance || 0;

      const profilePanel = document.getElementById('profilePanel');
      profilePanel.innerHTML = `
        <h2>Профиль: ${currentUser}</h2>
        <p>Баланс: ${balance} STAR</p>
        <h3>Ваши NFT:</h3>
        <div id="userNFTs"></div>
        <button onclick="logoutUser()">Выйти</button>
      `;
      profilePanel.style.display = 'block';

      // Показываем NFT пользователя
      const nftsSnap = await get(ref(db, 'nfts'));
      const nftsObj = nftsSnap.val() || {};
      const nfts = Object.values(nftsObj);

      const userNFTsDiv = document.getElementById('userNFTs');
      userNFTsDiv.innerHTML = '';

      nfts.filter(nft => nft.owner === currentUser).forEach(nft => {
        const div = document.createElement('div');
        div.className = 'card';
        div.style.width = 'auto';
        div.innerHTML = `
          <img src="${nft.image}" alt="NFT" style="max-width:100px;" />
          <p>${nft.title}</p>
          <p>Код: ${nft.code}</p>
          <p>Цена: ${nft.price} STAR</p>
          <p>Редкость: ${nft.rarity}</p>
          ${nft.forSale
            ? '<b>На продаже</b>'
            : `<button onclick="sellNFT('${nft.id}')">Продать</button>`
          }
        `;
        userNFTsDiv.appendChild(div);
      });
    }

    // Показать/спрятать профиль
    function toggleProfile() {
      const panel = document.getElementById('profilePanel');
      if (panel.style.display === 'block') {
        panel.style.display = 'none';
      } else {
        if (!currentUser) {
          alert('Пожалуйста, войдите в аккаунт');
          return;
        }
        renderProfile();
        panel.style.display = 'block';
      }
    }

    // Чат между пользователями

    async function loadChatUsers() {
      if (!currentUser) return;

      const usersSnap = await get(ref(db, 'users'));
      const usersObj = usersSnap.val() || {};

      const select = document.getElementById('chatUserSelect');
      select.innerHTML = '<option value="">Выберите получателя</option>';
      Object.keys(usersObj).forEach(u => {
        if (u !== currentUser) {
          const option = document.createElement('option');
          option.value = u;
          option.textContent = u;
          select.appendChild(option);
        }
      });

      loadChatMessages();
    }

    async function loadChatMessages() {
      if (!currentUser) return;

      const chatRef = ref(db, 'chats');
      onValue(chatRef, (snapshot) => {
        const chatsObj = snapshot.val() || {};
        const chatMessagesDiv = document.getElementById('chatMessages');
        chatMessagesDiv.innerHTML = '';

        const chatsArr = Object.values(chatsObj).filter(msg =>
          (msg.from === currentUser && msg.to === document.getElementById('chatUserSelect').value) ||
          (msg.to === currentUser && msg.from === document.getElementById('chatUserSelect').value)
        );

        chatsArr.sort((a,b) => a.timestamp - b.timestamp);

        chatsArr.forEach(msg => {
          const div = document.createElement('div');
          div.textContent = `${msg.from}: ${msg.text}`;
          div.className = msg.from === currentUser ? 'me' : 'other';
          chatMessagesDiv.appendChild(div);
        });

        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
      });
    }

    async function sendMessage() {
      const to = document.getElementById('chatUserSelect').value;
      const text = document.getElementById('chatText').value.trim();
      if (!to) {
        alert('Выберите получателя');
        return;
      }
      if (!text) {
        alert('Введите сообщение');
        return;
      }
      if (!currentUser) {
        alert('Войдите в аккаунт');
        return;
      }

      const chatRef = ref(db, 'chats');
      const newMsgRef = push(chatRef);
      await set(newMsgRef, {
        from: currentUser,
        to,
        text,
        timestamp: Date.now()
      });

      document.getElementById('chatText').value = '';
    }

    window.toggleProfile = toggleProfile;  // Для onclick в html
    window.loginUser = loginUser;
    window.logoutUser = logoutUser;
    window.sellNFT = sellNFT;
    window.buyNFT = buyNFT;
    window.sendMessage = sendMessage;
    window.loadChatMessages = loadChatMessages;

  </script>
</head>
<body>

<header>
  <button id="profileBtn" onclick="toggleProfile()" style="display:none;">Профиль</button>
  NFT Биржа
  <div id="userInfo"></div>
</header>

<div id="loginBox">
  <h2>Вход / Регистрация</h2>
  <input type="text" id="login" placeholder="Логин" autocomplete="username" />
  <input type="password" id="password" placeholder="Пароль" autocomplete="current-password" />
  <button onclick="loginUser()">Войти / Зарегистрироваться</button>
</div>

<div id="profilePanel"></div>

<div id="container" class="container" style="display:none;"></div>

<!-- Чат -->
<div id="chatBox">
  <h3>Чат</h3>
  <select id="chatUserSelect" onchange="loadChatMessages()"></select>
  <div id="chatMessages"></div>
  <input type="text" id="chatText" placeholder="Введите сообщение" />
  <button onclick="sendMessage()">Отправить</button>
</div>

<!-- Телеграм внизу -->
<div id="telegramFooter">
  <a href="https://t.me/Maxsimka172" target="_blank" rel="noopener">
    <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram" />
  </a>
</div>

</body>
</html>
