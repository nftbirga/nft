<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>NFT Биржа</title>
<style>
  body { font-family: Arial, sans-serif; background: #e6f0fa; padding: 15px; max-width: 1000px; margin: auto; }
  header { background: #0077cc; color: white; padding: 12px; text-align: center; position: relative; }
  #balanceDisplay { position: absolute; right: 15px; top: 12px; color: black; font-weight: bold; }
  #loginBox { max-width: 320px; margin: 30px auto; text-align: center; }
  #loginBox input { width: 100%; padding: 10px; margin: 8px 0; font-size: 18px; }
  #loginBox button { width: 100%; padding: 12px; font-size: 20px; background: #0077cc; color: white; border: none; border-radius: 6px; cursor: pointer; }
  #loginBox button:hover { background: #005fa3; }
  #sidebar { display: none; margin: 10px; gap: 15px; }
  #sidebar button { font-size: 18px; padding: 8px 15px; background: #0077cc; color: white; border: none; border-radius: 6px; cursor: pointer; }
  #sidebar button:hover { background: #005fa3; }
  #filterBar { display: none; margin: 10px auto; gap: 15px; justify-content: center; max-width: 500px; }
  #filterBar select { padding: 6px; font-size: 16px; }
  #nftContainer { display: none; flex-wrap: wrap; gap: 12px; justify-content: center; margin-top: 15px; }
  .card { background: white; border-radius: 8px; padding: 10px; width: 220px; box-shadow: 0 0 8px #aaa; text-align: center; }
  .card img { width: 100%; border-radius: 6px; }
  button.action-btn { background: #0077cc; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; margin-top: 6px; }
  button.action-btn:hover { background: #005fa3; }
  #profileSection { display: none; margin: 20px auto; max-width: 960px; }
  #profileNFTs { display: flex; gap: 10px; overflow-x: auto; padding: 10px; background: #dce6f7; border-radius: 6px; }
  #profileNFTs .card { width: 160px; }
  #chatSection { display: none; margin: 20px auto; max-width: 500px; }
  #chatMessages { height: 150px; width: 100%; border: 1px solid #ccc; padding: 6px; overflow-y: auto; white-space: pre-wrap; background: white; margin-bottom: 8px; }
  #telegramFooter { margin-top: 30px; text-align: center; }
  #telegramFooter img { cursor: pointer; width: 200px; max-width: 90vw; }
</style>
</head>
<body>

<header>
  <h1 style="text-align:center;">NFT Биржа</h1>
  <div id="balanceDisplay" style="display:none;">Баланс: 0 STAR</div>
</header>

<div id="loginBox">
  <input id="login" placeholder="Логин" autocomplete="username" />
  <input id="password" type="password" placeholder="Пароль" autocomplete="current-password" />
  <button onclick="loginUser()">Войти / Зарегистрироваться</button>
</div>

<div id="sidebar">
  <button onclick="toggleProfile()">Профиль</button>
  <button onclick="logout()" style="margin-left:20px;">Выйти</button>
</div>

<div id="filterBar">
  <select id="filterPrice" onchange="renderNFTs()">
    <option value="none">Цена: без фильтра</option>
    <option value="asc">Цена: по возрастанию</option>
    <option value="desc">Цена: по убыванию</option>
  </select>
  <select id="filterRarity" onchange="renderNFTs()">
    <option value="all">Редкость: все</option>
    <option value="0.01%">0.01%</option>
    <option value="0.1%">0.1%</option>
    <option value="0.5%">0.5%</option>
    <option value="1%">1%</option>
    <option value="2%">2%</option>
    <option value="3%">3%</option>
    <option value="4%">4%</option>
    <option value="5%">5%</option>
    <option value="tested">tested</option>
    <option value="error">error</option>
  </select>
</div>

<div id="nftContainer"></div>

<div id="profileSection">
  <h2>Ваши NFT</h2>
  <div id="profileNFTs"></div>
</div>

<div id="chatSection">
  <h3>Чат между пользователями</h3>
  <select id="chatRecipient" onchange="renderChatMessages()">
    <option value="">Выберите пользователя</option>
  </select><br/>
  <textarea id="chatMessages" readonly></textarea><br/>
  <input id="chatInput" placeholder="Введите сообщение..." />
  <button onclick="sendMessage()">Отправить</button>
</div>

<div id="telegramFooter">
  <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" 
       alt="Telegram" onclick="window.open('https://t.me/Maxsimka172', '_blank')" />
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getDatabase, ref, get, set, update, push, onValue, remove } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAAgeGGJAqYjQf0B8W_K7OX01aoriYeULo",
    authDomain: "nft-birga.firebaseapp.com",
    databaseURL: "https://nft-birga-default-rtdb.firebaseio.com/",
    projectId: "nft-birga",
    storageBucket: "nft-birga.appspot.com",
    messagingSenderId: "387414090259",
    appId: "1:387414090259:web:8342f9a11174433dc895e6",
    measurementId: "G-2Q5WNT0VGQ"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let currentUser = null;
  let users = {};
  let nfts = {};
  let chatMessages = [];

  // Загрузка пользователей
  async function loadUsers() {
    const snap = await get(ref(db, 'users'));
    users = snap.exists() ? snap.val() : {};
  }
  async function saveUser(login, data) {
    await update(ref(db, 'users/' + login), data);
  }

  // Загрузка NFT
  async function loadNFTs() {
    const snap = await get(ref(db, 'nfts'));
    nfts = snap.exists() ? snap.val() : {};
  }
  async function saveNFT(id, data) {
    await update(ref(db, 'nfts/' + id), data);
  }

  // Загрузка чата
  async function loadChatMessages() {
    const snap = await get(ref(db, 'chatMessages'));
    chatMessages = snap.exists() ? Object.values(snap.val()) : [];
  }
  async function addChatMessage(msg) {
    await push(ref(db, 'chatMessages'), msg);
  }

  // Вход / регистрация
  async function loginUser() {
    const login = document.getElementById('login').value.trim();
    const password = document.getElementById('password').value.trim();
    if (!login || !password) {
      alert('Введите логин и пароль');
      return;
    }
    await loadUsers();
    if (!users[login]) {
      users[login] = { password, balance: 0 };
      await saveUser(login, users[login]);
      alert('Регистрация успешна');
    } else if (users[login].password !== password) {
      alert('Неверный пароль');
      return;
    }
    currentUser = login;
    localStorage.setItem('currentUser', currentUser);
    showApp();
  }

  // Показать основное приложение после входа
  function showApp() {
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('sidebar').style.display = 'flex';
    document.getElementById('filterBar').style.display = 'flex';
    document.getElementById('nftContainer').style.display = 'flex';
    document.getElementById('profileSection').style.display = 'block';
    document.getElementById('chatSection').style.display = 'block';
    updateBalance();
    renderNFTs();
    renderProfileNFTs();
    populateChatRecipients();
  }

  // Выход
  function logout() {
    currentUser = null;
    localStorage.removeItem('currentUser');
    document.getElementById('loginBox').style.display = 'block';
    document.getElementById('sidebar').style.display = 'none';
    document.getElementById('filterBar').style.display = 'none';
    document.getElementById('nftContainer').style.display = 'none';
    document.getElementById('profileSection').style.display = 'none';
    document.getElementById('chatSection').style.display = 'none';
    clearInputs();
  }
  function clearInputs() {
    document.getElementById('login').value = '';
    document.getElementById('password').value = '';
    document.getElementById('chatInput').value = '';
  }

  // Отрисовка NFT
  function renderNFTs() {
    const container = document.getElementById('nftContainer');
    container.innerHTML = '';

    let nftArr = Object.values(nfts);

    const filterPrice = document.getElementById('filterPrice').value;
    const filterRarity = document.getElementById('filterRarity').value;

    if (filterRarity !== 'all') {
      nftArr = nftArr.filter(n => n.rarity === filterRarity);
    }

    if (filterPrice === 'asc') {
      nftArr.sort((a,b) => parseFloat(a.price) - parseFloat(b.price));
    } else if (filterPrice === 'desc') {
      nftArr.sort((a,b) => parseFloat(b.price) - parseFloat(a.price));
    }

    nftArr.forEach(nft => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <img src="${nft.image}" alt="${nft.title}" />
        <h3>${nft.title}</h3>
        <p>Код: ${nft.code}</p>
        <p>Редкость: ${nft.rarity}</p>
        <p>Владелец: ${nft.owner}</p>
        <p>Цена: ${nft.price} STAR</p>
        ${nft.owner === currentUser && !nft.forSale ? `<button class="action-btn" onclick="sellNFT('${nft.id}')">Продать</button>` : ''}
        ${nft.forSale && nft.owner !== currentUser ? `<button class="action-btn" onclick="buyNFT('${nft.id}')">Купить</button>` : ''}
        ${nft.owner === currentUser && nft.forSale ? `<button class="action-btn" onclick="cancelSale('${nft.id}')">Снять с продажи</button>` : ''}
      `;
      container.appendChild(card);
    });
  }

  // NFT профиля (горизонтально)
  function renderProfileNFTs() {
    const container = document.getElementById('profileNFTs');
    container.innerHTML = '';
    const userNFTs = Object.values(nfts).filter(n => n.owner === currentUser);
    userNFTs.forEach(nft => {
      const card = document.createElement('div');
      card.className = 'card';
      card.style.width = '150px';
      card.innerHTML = `
        <img src="${nft.image}" alt="${nft.title}" />
        <p>${nft.title}</p>
        <p>Код: ${nft.code}</p>
      `;
      container.appendChild(card);
    });
  }

  // Продать NFT
  async function sellNFT(id) {
    const price = prompt('Введите цену продажи (STAR, не меньше 0)');
    if (price === null) return;
    const p = parseFloat(price);
    if (isNaN(p) || p < 0) {
      alert('Введите корректную цену не меньше 0');
      return;
    }
    if (!nfts[id] || nfts[id].owner !== currentUser) {
      alert('Это не ваш NFT');
      return;
    }
    nfts[id].price = p.toFixed(2);
    nfts[id].forSale = true;
    await saveNFT(id, nfts[id]);
    await loadNFTs();
    renderNFTs();
    renderProfileNFTs();
  }

  // Купить NFT
  async function buyNFT(id) {
    if (!nfts[id] || !nfts[id].forSale) {
      alert('NFT не продается');
      return;
    }
    const price = parseFloat(nfts[id].price);
    if (users[currentUser].balance < price) {
      alert('Недостаточно средств');
      return;
    }
    const seller = nfts[id].owner;
    users[currentUser].balance -= price;
    users[seller].balance += price;
    nfts[id].owner = currentUser;
    nfts[id].forSale = false;

    await saveUser(currentUser, users[currentUser]);
    await saveUser(seller, users[seller]);
    await saveNFT(id, nfts[id]);

    await loadNFTs();
    renderNFTs();
    renderProfileNFTs();
    updateBalance();
  }

  // Снять с продажи
  async function cancelSale(id) {
    if (!nfts[id] || nfts[id].owner !== currentUser) {
      alert('Это не ваш NFT');
      return;
    }
    nfts[id].forSale = false;
    await saveNFT(id, nfts[id]);
    await loadNFTs();
    renderNFTs();
    renderProfileNFTs();
  }

  // Обновить баланс
  function updateBalance() {
    const balEl = document.getElementById('balanceDisplay');
    balEl.style.display = 'block';
    balEl.textContent = `Баланс: ${users[currentUser]?.balance ?? 0} STAR`;
  }

  // Показать/скрыть профиль
  function toggleProfile() {
    const prof = document.getElementById('profileSection');
    prof.style.display = prof.style.display === 'block' ? 'none' : 'block';
  }

  // Чат
  async function populateChatRecipients() {
    await loadUsers();
    const select = document.getElementById('chatRecipient');
    select.innerHTML = '<option value="">Выберите пользователя</option>';
    Object.keys(users).forEach(u => {
      if (u !== currentUser) {
        const opt = document.createElement('option');
        opt.value = u;
        opt.textContent = u;
        select.appendChild(opt);
      }
    });
    renderChatMessages();
  }

  function renderChatMessages() {
    const recipient = document.getElementById('chatRecipient').value;
    const chatBox = document.getElementById('chatMessages');
    chatBox.textContent = '';
    if (!recipient) return;
    const filtered = chatMessages.filter(m =>
      (m.from === currentUser && m.to === recipient) ||
      (m.from === recipient && m.to === currentUser)
    );
    filtered.forEach(m => {
      chatBox.textContent += `${m.from}: ${m.text}\n`;
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  async function sendMessage() {
    const recipient = document.getElementById('chatRecipient').value;
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text) return;
    if (!recipient) {
      alert('Выберите получателя');
      return;
    }
    const msg = { from: currentUser, to: recipient, text, timestamp: Date.now() };
    await addChatMessage(msg);
    input.value = '';
    await loadChatMessages();
    renderChatMessages();
  }

  // Загрузка данных с подпиской
  async function loadData() {
    await loadUsers();
    await loadNFTs();
    await loadChatMessages();

    onValue(ref(db, 'nfts'), (snapshot) => {
      nfts = snapshot.exists() ? snapshot.val() : {};
      renderNFTs();
      renderProfileNFTs();
    });
    onValue(ref(db, 'chatMessages'), (snapshot) => {
      chatMessages = snapshot.exists() ? Object.values(snapshot.val()) : [];
      renderChatMessages();
    });
  }

  // Инициализация страницы
  async function init() {
    await loadData();
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser && users[savedUser]) {
      currentUser = savedUser;
      showApp();
    }
  }

  init();

  window.loginUser = loginUser;
  window.logout = logout;
  window.toggleProfile = toggleProfile;
  window.sellNFT = sellNFT;
  window.buyNFT = buyNFT;
  window.cancelSale = cancelSale;
  window.sendMessage = sendMessage;
  window.renderNFTs = renderNFTs;
  window.renderChatMessages = renderChatMessages;

</script>

</body>
</html>
