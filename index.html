<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>NFT Биржа с Firebase</title>
<style>
  body { background: #e6f0fa; font-family: sans-serif; color: #000; max-width: 900px; margin: auto; padding: 20px; }
  header { background: #0077cc; color: #fff; padding: 15px; text-align: center; font-size: 24px; font-weight: bold; }
  .container { padding: 20px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
  .card { background: #fff; border-radius: 8px; padding: 10px; width: 200px; box-shadow: 0 0 5px #aaa; text-align: center; }
  .card img { width: 100%; border-radius: 6px; }
  button { background: #0077cc; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; margin-top: 5px; width: 100%; }
  button:hover { background: #005fa3; }
  #loginBox { max-width: 300px; margin: 30px auto; text-align: center; }
  input { width: 100%; padding: 10px; margin: 10px 0; font-size: 16px; box-sizing: border-box; }
  #profilePanel { background: #fff; border-radius: 8px; padding: 10px; margin: 10px auto; max-width: 300px; display: none; box-shadow: 0 0 8px #0077cc; }
  #profilePanel button { margin-top: 15px; font-size: 16px; }
</style>
</head>
<body>

<header>NFT Биржа</header>

<div id="loginBox">
  <input id="login" placeholder="Логин" />
  <input id="password" placeholder="Пароль" type="password" />
  <button id="loginBtn">Войти / Зарегистрироваться</button>
</div>

<div id="userInfo" style="text-align:center; margin-top: 15px;"></div>

<div id="profilePanel">
  <h3>Профиль: <span id="profileLogin"></span></h3>
  <p>Баланс: <span id="profileBalance"></span> STAR</p>
  <button id="logoutBtn">Выйти</button>
</div>

<div class="container" id="nftContainer" style="display:none;"></div>

<footer style="margin-top:40px; text-align:center;">
  <a href="https://t.me/Maxsimka172" target="_blank" rel="noopener" title="Telegram">
    <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram" style="width:120px;"/>
  </a>
</footer>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAAgeGGJAqYjQf0B8W_K7OX01aoriYeULo",
    authDomain: "nft-birga.firebaseapp.com",
    databaseURL: "https://nft-birga-default-rtdb.firebaseio.com",
    projectId: "nft-birga",
    storageBucket: "nft-birga.appspot.com",
    messagingSenderId: "387414090259",
    appId: "1:387414090259:web:8342f9a11174433dc895e6",
    measurementId: "G-2Q5WNT0VGQ"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let currentUser = null;

  const loginBox = document.getElementById('loginBox');
  const nftContainer = document.getElementById('nftContainer');
  const profilePanel = document.getElementById('profilePanel');
  const userInfo = document.getElementById('userInfo');

  document.getElementById('loginBtn').addEventListener('click', async () => {
    const login = document.getElementById('login').value.trim();
    const password = document.getElementById('password').value.trim();
    if (!login || !password) {
      alert('Введите логин и пароль');
      return;
    }

    try {
      const userSnap = await db.ref('users/' + login).once('value');
      if (!userSnap.exists()) {
        // Регистрация нового пользователя
        await db.ref('users/' + login).set({ password, balance: 0 });
        alert('Пользователь зарегистрирован');
      } else {
        const data = userSnap.val();
        if (data.password !== password) {
          alert('Неверный пароль');
          return;
        }
      }
      currentUser = login;
      loginBox.style.display = 'none';
      nftContainer.style.display = 'flex';
      profilePanel.style.display = 'block';
      updateUserInfo();
      renderNFTs();
    } catch (e) {
      console.error('Ошибка входа:', e);
      alert('Ошибка входа. Посмотрите консоль.');
    }
  });

  document.getElementById('logoutBtn').addEventListener('click', () => {
    currentUser = null;
    loginBox.style.display = 'block';
    nftContainer.style.display = 'none';
    profilePanel.style.display = 'none';
    userInfo.textContent = '';
    document.getElementById('login').value = '';
    document.getElementById('password').value = '';
  });

  async function updateUserInfo() {
    if (!currentUser) return;
    try {
      const userSnap = await db.ref('users/' + currentUser).once('value');
      if (!userSnap.exists()) return;
      const user = userSnap.val();
      userInfo.innerHTML = `Пользователь: <b>${currentUser}</b> | Баланс: ${user.balance} STAR`;
      document.getElementById('profileLogin').textContent = currentUser;
      document.getElementById('profileBalance').textContent = user.balance;
    } catch (e) {
      console.error('Ошибка обновления профиля:', e);
    }
  }

  async function renderNFTs() {
    try {
      nftContainer.innerHTML = '';
      const nftsSnap = await db.ref('nfts').once('value');
      if (!nftsSnap.exists()) return;
      const nfts = nftsSnap.val();

      nfts.forEach(nft => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img src="${nft.image}" alt="NFT" />
          <h3>${nft.title}</h3>
          <p>Код: ${nft.code}</p>
          <p>Редкость: ${nft.rarity}</p>
          <p>Владелец: ${nft.owner}</p>
          <p>Цена: ${nft.price} STAR</p>
        `;

        if (nft.owner === currentUser && !nft.forSale) {
          const btn = document.createElement('button');
          btn.textContent = 'Продать';
          btn.onclick = () => sellNFT(nft.id);
          card.appendChild(btn);
        } else if (nft.owner === currentUser && nft.forSale) {
          const btn = document.createElement('button');
          btn.textContent = 'Снять с продажи';
          btn.onclick = () => cancelSale(nft.id);
          card.appendChild(btn);
        } else if (nft.forSale && nft.owner !== currentUser) {
          const btn = document.createElement('button');
          btn.textContent = 'Купить';
          btn.onclick = () => buyNFT(nft.id);
          card.appendChild(btn);
        }

        nftContainer.appendChild(card);
      });
    } catch (e) {
      console.error('Ошибка загрузки NFT:', e);
    }
  }

  async function sellNFT(id) {
    const priceStr = prompt('Введите цену за NFT (минимум 0)');
    const price = parseFloat(priceStr);
    if (isNaN(price) || price < 0) {
      alert('Цена должна быть >= 0');
      return;
    }

    try {
      const nftsSnap = await db.ref('nfts').once('value');
      let nfts = nftsSnap.val() || [];
      const idx = nfts.findIndex(n => n.id === id);
      if (idx === -1) return;
      nfts[idx].price = price;
      nfts[idx].forSale = true;
      await db.ref('nfts').set(nfts);
      renderNFTs();
    } catch (e) {
      console.error('Ошибка выставления на продажу:', e);
    }
  }

  async function cancelSale(id) {
    try {
      const nftsSnap = await db.ref('nfts').once('value');
      let nfts = nftsSnap.val() || [];
      const idx = nfts.findIndex(n => n.id === id);
      if (idx === -1) return;
      nfts[idx].forSale = false;
      await db.ref('nfts').set(nfts);
      renderNFTs();
    } catch (e) {
      console.error('Ошибка снятия с продажи:', e);
    }
  }

  async function buyNFT(id) {
    try {
      if (!currentUser) {
        alert('Войдите для покупки');
        return;
      }
      const [nftsSnap, usersSnap] = await Promise.all([
        db.ref('nfts').once('value'),
        db.ref('users').once('value')
      ]);
      let nfts = nftsSnap.val() || [];
      let users = usersSnap.val() || {};

      const nftIndex = nfts.findIndex(n => n.id === id);
      if (nftIndex === -1) return alert('NFT не найден');

      const nft = nfts[nftIndex];
      if (!nft.forSale) return alert('NFT не выставлен на продажу');

      const buyer = users[currentUser];
      const seller = users[nft.owner] || { balance: 0 };

      if (!buyer || buyer.balance < nft.price) {
        return alert('Недостаточно средств');
      }

      // Переводим деньги
      users[currentUser].balance -= nft.price;
      users[nft.owner].balance += nft.price;

      // Передаём NFT
      nfts[nftIndex].owner = currentUser;
      nfts[nftIndex].forSale = false;

      await Promise.all([
        db.ref('users').set(users),
        db.ref('nfts').set(nfts)
      ]);

      alert('Покупка успешна');
      updateUserInfo();
      renderNFTs();

    } catch (e) {
      console.error('Ошибка покупки:', e);
    }
  }

</script>

</body>
</html>

