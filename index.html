<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>NFT Биржа с Профилем</title>
  <style>
    body { background: #e6f0fa; font-family: sans-serif; color: #000; margin: 0; }
    header {
      background: #0077cc;
      color: #fff;
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
    }
    #profileTab {
      cursor: pointer;
      background: #005fa3;
      padding: 8px 12px;
      border-radius: 4px;
      user-select: none;
      min-width: 70px;
      text-align: center;
    }
    header h1 {
      margin: 0;
      flex-grow: 1;
      text-align: center;
    }
    #userInfo {
      margin: 0;
      width: 130px;
      text-align: right;
      font-weight: 600;
    }
    #profileWindow {
      position: absolute;
      top: 50px; left: 10px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      width: 300px;
      max-height: 400px;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      display: none;
      z-index: 100;
    }
    .container {
      padding: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      width: 200px;
      box-shadow: 0 0 5px #aaa;
      text-align: center;
    }
    .card img {
      width: 100%;
      border-radius: 6px;
    }
    button {
      background: #0077cc;
      color: white;
      border: none;
      padding: 8px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 5px;
    }
    button:hover {
      background: #005fa3;
    }
    #loginBox {
      max-width: 300px;
      margin: 20px auto;
      text-align: center;
    }
    .filters {
      margin: 10px auto;
      max-width: 300px;
      display: flex;
      gap: 5px;
    }
    /* Scrollbar for profileWindow */
    #profileWindow::-webkit-scrollbar {
      width: 6px;
    }
    #profileWindow::-webkit-scrollbar-thumb {
      background: #0077cc;
      border-radius: 3px;
    }
  </style>
</head>
<body>

<header>
  <div id="profileTab" title="Профиль">Профиль</div>
  <h1>Биржа NFT</h1>
  <p id="userInfo"></p>
</header>

<div id="profileWindow">
  <h3>Мои NFT</h3>
  <div id="profileNFTs">Загрузка...</div>
  <button onclick="closeProfile()">Закрыть</button>
</div>

<div id="loginBox">
  <input id="login" placeholder="Логин"><br />
  <input id="password" placeholder="Пароль" type="password" /><br />
  <button onclick="login()">Войти / Регистрация</button>
</div>

<div class="filters" style="display:none;" id="filterBox">
  <select id="sortPrice" onchange="renderNFTs()">
    <option value="">Сортировать по цене</option>
    <option value="asc">Цена ↑</option>
    <option value="desc">Цена ↓</option>
  </select>
  <select id="sortRarity" onchange="renderNFTs()">
    <option value="">Сортировать по редкости</option>
    <option value="asc">Редкость ↑</option>
    <option value="desc">Редкость ↓</option>
  </select>
</div>

<div class="container" id="nftContainer" style="display:none;"></div>

<script>
let currentUser = null;

function login() {
  const login = document.getElementById('login').value.trim();
  const password = document.getElementById('password').value.trim();

  if (!login || !password) {
    alert('Введите логин и пароль');
    return;
  }

  let users;
  try {
    users = JSON.parse(localStorage.getItem('users')) || {};
  } catch (e) {
    users = {};
  }

  if (!users[login]) {
    users[login] = { password, balance: 0 };
    alert(`Регистрация успешна: ${login}`);
  } else if (users[login].password !== password) {
    alert('Неверный пароль');
    return;
  }

  localStorage.setItem('users', JSON.stringify(users));
  currentUser = login;
  document.getElementById('loginBox').style.display = 'none';
  document.getElementById('nftContainer').style.display = 'flex';
  document.getElementById('filterBox').style.display = 'flex';
  updateUserInfo();
  renderNFTs();
}

// Показываем данные профиля
const profileTab = document.getElementById('profileTab');
const profileWindow = document.getElementById('profileWindow');

profileTab.onclick = () => {
  if (!currentUser) {
    alert('Сначала войдите в систему');
    return;
  }
  profileWindow.style.display = 'block';
  renderProfileNFTs();
};

function closeProfile() {
  profileWindow.style.display = 'none';
}

function updateUserInfo() {
  const users = JSON.parse(localStorage.getItem('users')) || {};
  const user = users[currentUser];
  document.getElementById('userInfo').innerHTML = `Пользователь: <b>${currentUser}</b> | Баланс: ${user.balance} STAR`;
}

function parseRarity(value) {
  const n = parseFloat(value);
  return isNaN(n) ? 999 : n;
}

function renderNFTs() {
  const container = document.getElementById('nftContainer');
  container.innerHTML = '';
  let nfts = JSON.parse(localStorage.getItem('nfts')) || [];

  const sortPrice = document.getElementById('sortPrice').value;
  const sortRarity = document.getElementById('sortRarity').value;

  if (sortPrice) {
    nfts.sort((a, b) => sortPrice === 'asc' ? a.price - b.price : b.price - a.price);
  } else if (sortRarity) {
    nfts.sort((a, b) =>
      sortRarity === 'asc'
        ? parseRarity(a.rarity) - parseRarity(b.rarity)
        : parseRarity(b.rarity) - parseRarity(a.rarity)
    );
  }

  nfts.forEach(nft => {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <img src="${nft.image}">
      <h3>${nft.title}</h3>
      <p>Код: ${nft.code}</p>
      <p>Редкость: ${nft.rarity}</p>
      <p>Владелец: ${nft.owner}</p>
      <p>Цена: ${nft.price} STAR</p>
      ${
        nft.owner === currentUser && !nft.forSale
          ? `<button onclick="sellNFT(${nft.id})">Продать</button>`
          : nft.forSale && nft.owner !== currentUser
          ? `<button onclick="buyNFT(${nft.id})">Купить</button>`
          : ''
      }
    `;
    container.appendChild(div);
  });
}

function renderProfileNFTs() {
  const profileNFTsDiv = document.getElementById('profileNFTs');
  let nfts = JSON.parse(localStorage.getItem('nfts')) || [];
  const myNFTs = nfts.filter(n => n.owner === currentUser);

  if (myNFTs.length === 0) {
    profileNFTsDiv.innerHTML = '<p>У вас пока нет NFT.</p>';
    return;
  }

  profileNFTsDiv.innerHTML = '';
  myNFTs.forEach(nft => {
    const div = document.createElement('div');
    div.style.borderBottom = '1px solid #ccc';
    div.style.padding = '6px 0';

    div.innerHTML = `
      <strong>${nft.title}</strong> <br>
      Код: ${nft.code} <br>
      Цена: ${nft.price} STAR <br>
      Редкость: ${nft.rarity} <br>
      ${nft.forSale ? '<em>На продаже</em>' : '<em>Не на продаже</em>'}
    `;

    profileNFTsDiv.appendChild(div);
  });
}

function sellNFT(id) {
  const price = prompt('Введите цену за NFT (в STAR)');
  if (!price || isNaN(price)) return;

  let nfts = JSON.parse(localStorage.getItem('nfts')) || [];
  nfts = nfts.map(n => (n.id === id ? { ...n, price, forSale: true } : n));
  localStorage.setItem('nfts', JSON.stringify(nfts));
  renderNFTs();
  if (profileWindow.style.display === 'block') renderProfileNFTs();
}

function buyNFT(id) {
  let nfts = JSON.parse(localStorage.getItem('nfts')) || [];
  const nft = nfts.find(n => n.id === id);
  if (!nft || !nft.forSale) return;

  let users = JSON.parse(localStorage.getItem('users')) || {};
  if (users[currentUser].balance < nft.price) {
    alert('Недостаточно STAR');
    return;
  }

  users[currentUser].balance -= Number(nft.price);
  if (!users[nft.owner]) users[nft.owner] = { password: '', balance: 0 };
  users[nft.owner].balance += Number(nft.price);

  nft.owner = currentUser;
  nft.forSale = false;

  localStorage.setItem('users', JSON.stringify(users));
  localStorage.setItem('nfts', JSON.stringify(nfts));
  updateUserInfo();
  renderNFTs();
  if (profileWindow.style.display === 'block') renderProfileNFTs();
}
</script>

</body>
</html>
