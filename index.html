<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>NFT Биржа</title>
  <style>
    body { background: #e6f0fa; font-family: sans-serif; color: #000; margin: 0; }
    header { background: #0077cc; color: #fff; padding: 15px; text-align: center; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: #fff; }
    .container { padding: 20px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    .card { background: #fff; border-radius: 8px; padding: 10px; width: 200px; box-shadow: 0 0 5px #aaa; text-align: center; }
    .card img { width: 100%; border-radius: 6px; }
    button { background: #0077cc; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; margin-top: 5px; }
    button:hover { background: #005fa3; }
    #loginBox { max-width: 300px; margin: 40px auto; text-align: center; }
    #filters { margin: 10px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    #profilePopup { position: fixed; top: 60px; left: 10px; background: white; border: 1px solid #ccc; padding: 10px; display: none; z-index: 10; max-width: 300px; max-height: 80vh; overflow-y: auto; }
  </style>
</head>
<body>

<header>
  <h1 style="margin: 0;">NFT Биржа</h1>
</header>

<div class="top-bar">
  <button onclick="toggleProfile()">Профиль</button>
  <p id="userInfo">Вход не выполнен</p>
</div>

<div id="loginBox">
  <input id="login" placeholder="Логин"><br>
  <input id="password" placeholder="Пароль" type="password"><br>
  <button onclick="loginUser()">Войти / Регистрация</button>
</div>

<div id="filters" style="display:none;">
  <select id="sortPrice" onchange="renderNFTs()">
    <option value="">Сортировка по цене</option>
    <option value="asc">Сначала дешёвые</option>
    <option value="desc">Сначала дорогие</option>
  </select>
  <select id="filterRarity" onchange="renderNFTs()">
    <option value="">Все редкости</option>
    <option value="0.01%">0.01%</option>
    <option value="0.1%">0.1%</option>
    <option value="1%">1%</option>
    <option value="2%">2%</option>
    <option value="3%">3%</option>
    <option value="5%">5%</option>
    <option value="tested">tested</option>
    <option value="error">error</option>
  </select>
</div>

<div id="profilePopup"></div>

<div class="container" id="nftContainer" style="display:none;"></div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getDatabase, ref, get, set, push, onValue, update } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAAgeGGJAqYjQf0B8W_K7OX01aoriYeULo",
    authDomain: "nft-birga.firebaseapp.com",
    databaseURL: "https://nft-birga-default-rtdb.firebaseio.com",
    projectId: "nft-birga",
    storageBucket: "nft-birga.appspot.com",
    messagingSenderId: "387414090259",
    appId: "1:387414090259:web:8342f9a11174433dc895e6",
    measurementId: "G-2Q5WNT0VGQ"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let currentUser = null;
  let nftData = {};

  async function loginUser() {
    const login = document.getElementById('login').value.trim();
    const password = document.getElementById('password').value.trim();
    if (!login || !password) return alert("Введите логин и пароль");

    const userRef = ref(db, 'users/' + login);
    const snap = await get(userRef);

    if (snap.exists() && snap.val().password !== password) {
      return alert("Неверный пароль");
    }

    await set(userRef, {
      ...(snap.exists() ? snap.val() : {}),
      password,
      balance: snap.exists() ? snap.val().balance : 0
    });

    currentUser = login;
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('nftContainer').style.display = 'flex';
    document.getElementById('filters').style.display = 'flex';
    updateUserInfo();
    renderNFTs();
  }

  async function updateUserInfo() {
    const snap = await get(ref(db, 'users/' + currentUser));
    if (snap.exists()) {
      const user = snap.val();
      document.getElementById('userInfo').innerHTML = `Пользователь: <b>${currentUser}</b> | Баланс: ${user.balance} STAR`;
    }
  }

  function renderNFTs() {
    const container = document.getElementById('nftContainer');
    const sort = document.getElementById('sortPrice').value;
    const filter = document.getElementById('filterRarity').value;

    const nfts = Object.entries(nftData || {}).map(([key, nft]) => ({ ...nft, key }));
    let filtered = nfts.filter(nft => !filter || nft.rarity === filter);

    if (sort === 'asc') filtered.sort((a, b) => a.price - b.price);
    if (sort === 'desc') filtered.sort((a, b) => b.price - a.price);

    container.innerHTML = '';
    for (const nft of filtered) {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <img src="${nft.image}">
        <h3>${nft.title}</h3>
        <p>Код: ${nft.code}</p>
        <p>Редкость: ${nft.rarity}</p>
        <p>Владелец: ${nft.owner}</p>
        <p>Цена: ${nft.price} STAR</p>
        ${
          nft.owner === currentUser && !nft.forSale
            ? `<button onclick="sellNFT('${nft.key}')">Продать</button>`
            : nft.forSale && nft.owner !== currentUser
              ? `<button onclick="buyNFT('${nft.key}', ${nft.price})">Купить</button>`
              : ''
        }
      `;
      container.appendChild(div);
    }
  }

  async function sellNFT(key) {
    const price = prompt("Введите цену в STAR:");
    if (!price || isNaN(price)) return;
    await update(ref(db, 'nfts/' + key), { price: Number(price), forSale: true });
    renderNFTs();
  }

  async function buyNFT(key, price) {
    const userSnap = await get(ref(db, 'users/' + currentUser));
    const nftSnap = await get(ref(db, 'nfts/' + key));
    if (!nftSnap.exists()) return alert("NFT не найден");
    const nft = nftSnap.val();
    if (userSnap.val().balance < price) return alert("Недостаточно STAR");

    // обновление балансов
    const sellerRef = ref(db, 'users/' + nft.owner);
    const sellerSnap = await get(sellerRef);
    await update(ref(db, 'users/' + currentUser), {
      balance: userSnap.val().balance - price
    });
    await update(sellerRef, {
      balance: (sellerSnap.exists() ? sellerSnap.val().balance : 0) + price
    });

    await update(ref(db, 'nfts/' + key), { owner: currentUser, forSale: false });
    updateUserInfo();
    renderNFTs();
  }

  function toggleProfile() {
    const box = document.getElementById('profilePopup');
    if (box.style.display === 'block') {
      box.style.display = 'none';
      return;
    }
    const userNFTs = Object.values(nftData).filter(n => n.owner === currentUser);
    box.innerHTML = `<h3>NFT пользователя ${currentUser}</h3>` +
      userNFTs.map(n => `<div><b>${n.title}</b> (${n.code})</div>`).join('');
    box.style.display = 'block';
  }

  onValue(ref(db, 'nfts'), snap => {
    nftData = snap.val() || {};
    if (currentUser) renderNFTs();
  });
</script>
</body>
</html>
