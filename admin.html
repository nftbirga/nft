<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Админка NFT</title>
  <style>
    body { font-family: sans-serif; background: #eef4fb; padding: 20px; color: #000; }
    input, select, button { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; }
    .nft { background: #fff; border-radius: 8px; padding: 10px; margin-top: 10px; box-shadow: 0 0 5px #aaa; }
    img { max-width: 100%; }
    button.del { background: #ff4444; }
  </style>
</head>
<body>

<h1>Админка: создать NFT-модель</h1>

<input id="title" placeholder="Название модели">
<input id="image" placeholder="URL изображения">
<input id="price" placeholder="Цена по умолчанию (STAR)">
<select id="rarity">
  <option>Выбери редкость</option>
  <option value="0.01%">0.01%</option>
  <option value="0.1%">0.1%</option>
  <option value="0.5%">0.5%</option>
  <option value="1%">1%</option>
  <option value="2%">2%</option>
  <option value="3%">3%</option>
  <option value="4%">4%</option>
  <option value="5%">5%</option>
  <option value="tested">tested</option>
  <option value="error">error</option>
</select>
<input id="quantity" type="number" placeholder="Сколько NFT выпустить">
<button onclick="createModel()">Создать NFT</button>

<h2>Пополнить пользователю баланс</h2>
<input id="userLogin" placeholder="Логин пользователя">
<input id="amountToAdd" placeholder="Сколько STAR пополнить">
<button onclick="addBalance()">Пополнить</button>

<h2>История NFT, выпущенных админом</h2>
<div id="history"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getDatabase, ref, get, set, push, remove } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAAgeGGJAqYjQf0B8W_K7OX01aoriYeULo",
    authDomain: "nft-birga.firebaseapp.com",
    databaseURL: "https://nft-birga-default-rtdb.firebaseio.com",
    projectId: "nft-birga",
    storageBucket: "nft-birga.appspot.com",
    messagingSenderId: "387414090259",
    appId: "1:387414090259:web:8342f9a11174433dc895e6",
    measurementId: "G-2Q5WNT0VGQ"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  function getLetterCode(idx) {
    const a = 97 + (idx % 26);
    const b = 97 + Math.floor(idx / 26);
    return String.fromCharCode(a) + String.fromCharCode(b);
  }

  async function createModel() {
    const title = titleInput.value.trim();
    const image = imageInput.value.trim();
    const price = Number(priceInput.value.trim());
    const rarity = rarityInput.value;
    const quantity = parseInt(quantityInput.value);
    if (!title || !image || !price || !rarity || quantity <= 0) {
      return alert("Заполните все поля");
    }

    const snap = await get(ref(db, 'models'));
    const models = snap.val() || {};
    const idxs = Object.keys(models).map(k => +k);
    const index = idxs.length ? Math.max(...idxs) + 1 : 0;

    await set(ref(db, `models/${index}`), { title, image, price, rarity });

    for (let i = 0; i < quantity; i++) {
      const code = String(i + 1).padStart(12, '0') + getLetterCode(index);
      await set(push(ref(db, 'nfts')), {
        title, image, price, rarity,
        code, owner: "admin", forSale: false
      });
    }

    renderHistory();
  }

  async function addBalance() {
    const login = userLogin.value.trim();
    const amount = parseInt(amountToAdd.value.trim());
    if (!login || isNaN(amount)) return alert("Введите логин и сумму");
    const snap = await get(ref(db, 'users/' + login));
    const user = snap.val() || { balance: 0, password: "" };
    user.balance += amount;
    await set(ref(db, 'users/' + login), user);
    alert(`Баланс ${login} +${amount} STAR`);
  }

  async function renderHistory() {
    const history = document.getElementById('history');
    const snap = await get(ref(db, 'nfts'));
    const list = Object.entries(snap.val() || {}).filter(([_,n]) => n.owner === 'admin');
    history.innerHTML = list.map(([k,n]) => `
      <div class="nft">
        <img src="${n.image}">
        <h3>${n.title}</h3>
        <p>Код: ${n.code}</p>
        <p>Цена: ${n.price} STAR</p>
        <p>Редкость: ${n.rarity}</p>
        <button class="del" onclick="deleteNFT('${k}')">Удалить</button>
      </div>
    `).join('');
  }

  window.deleteNFT = async k => {
    if (confirm("Удалить NFT?")) {
      await remove(ref(db, 'nfts/' + k));
      renderHistory();
    }
  };

  window.createModel = createModel;
  window.addBalance = addBalance;

  renderHistory();
</script>

</body>
</html>
