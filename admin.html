<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Админка NFT с Firebase</title>
<style>
  body { font-family: sans-serif; background: #eef4fb; padding: 20px; color: #000; max-width: 600px; margin: auto;}
  h1, h2 { color: #000; }
  input, select, button { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; }
  .nft { background: #fff; border-radius: 8px; padding: 10px; margin-top: 10px; box-shadow: 0 0 5px #aaa; display: flex; align-items: center; gap:10px; }
  .nft img { width: 50px; border-radius: 4px; }
  .btn { cursor: pointer; background:#0077cc; color:#fff; border:none; border-radius:4px; padding:8px; }
</style>
</head>
<body>

<h1>Админка: создать NFT-модель и выпустить NFT</h1>

<input id="title" placeholder="Название модели" />
<input id="image" placeholder="URL изображения" />
<input id="price" placeholder="Цена по умолчанию (STAR)" />
<select id="rarity">
  <option value="">Выбери редкость</option>
  <option value="0.01%">0.01%</option>
  <option value="0.1%">0.1%</option>
  <option value="0.5%">0.5%</option>
  <option value="1%">1%</option>
  <option value="2%">2%</option>
  <option value="3%">3%</option>
  <option value="4%">4%</option>
  <option value="5%">5%</option>
  <option value="tested">tested</option>
  <option value="error">error</option>
</select>
<input id="quantity" type="number" placeholder="Сколько NFT выпустить" />
<button class="btn" id="createNFTBtn">Создать и Выпустить NFT</button>

<h2>Пополнить / Снять баланс пользователя</h2>
<input id="userLogin" placeholder="Логин пользователя" />
<input id="amountToAdd" type="number" placeholder="Сумма (может быть отрицательной)" />
<button class="btn" id="changeBalanceBtn">Изменить баланс</button>

<h2>История выпущенных NFT</h2>
<div id="history"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script>
  // Конфиг Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAAgeGGJAqYjQf0B8W_K7OX01aoriYeULo",
    authDomain: "nft-birga.firebaseapp.com",
    databaseURL: "https://nft-birga-default-rtdb.firebaseio.com",
    projectId: "nft-birga",
    storageBucket: "nft-birga.appspot.com",
    messagingSenderId: "387414090259",
    appId: "1:387414090259:web:8342f9a11174433dc895e6",
    measurementId: "G-2Q5WNT0VGQ"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  function generateNFTCode(modelKey, index) {
    const num = String(index + 1).padStart(7, '0');
    const letters = String.fromCharCode(97 + (modelKey % 26)) + String.fromCharCode(97 + (Math.floor(modelKey / 26) % 26));
    return num + letters;
  }

  async function addModel() {
    try {
      const title = document.getElementById('title').value.trim();
      const image = document.getElementById('image').value.trim();
      const price = parseFloat(document.getElementById('price').value.trim());
      const rarity = document.getElementById('rarity').value;
      const quantity = parseInt(document.getElementById('quantity').value);

      if(!title || !image || isNaN(price) || !rarity || !quantity || quantity <= 0) {
        alert('Заполните все поля корректно!');
        return;
      }

      // Получаем модели
      let modelsSnapshot = await db.ref('models').once('value');
      let models = modelsSnapshot.val() || [];

      // Проверяем есть ли модель
      let modelKey = models.findIndex(m => m.title === title);
      if(modelKey === -1){
        modelKey = models.length;
        models.push({ title, image, price, rarity, system: "extem beta" });
      } else {
        models[modelKey] = { title, image, price, rarity, system: "extem beta" };
      }
      await db.ref('models').set(models);

      // Получаем NFT
      let nftsSnapshot = await db.ref('nfts').once('value');
      let nfts = nftsSnapshot.val() || [];

      // Считаем сколько NFT уже есть у этой модели
      const existingCount = nfts.filter(n => n.title === title).length;

      for(let i=0; i < quantity; i++) {
        const code = generateNFTCode(modelKey, existingCount + i);
        nfts.push({
          id: Date.now() + i,
          title,
          image,
          price,
          rarity,
          code,
          owner: 'admin',
          forSale: false
        });
      }

      await db.ref('nfts').set(nfts);
      alert('NFT созданы и выпущены!');
      renderHistory();

    } catch (e) {
      console.error('Ошибка создания NFT:', e);
      alert('Ошибка создания NFT. Посмотрите консоль.');
    }
  }

  async function changeBalance(){
    try {
      const login = document.getElementById('userLogin').value.trim();
      const amount = parseFloat(document.getElementById('amountToAdd').value);
      if(!login || isNaN(amount)) {
        alert('Введите корректный логин и сумму');
        return;
      }
      const usersSnapshot = await db.ref('users').once('value');
      let users = usersSnapshot.val() || {};

      if(!users[login]) users[login] = { password: '', balance: 0 };
      users[login].balance = (users[login].balance || 0) + amount;

      await db.ref('users').set(users);
      alert(`Баланс пользователя ${login} изменён на ${amount} STAR`);
    } catch(e) {
      console.error('Ошибка изменения баланса:', e);
      alert('Ошибка изменения баланса. Посмотрите консоль.');
    }
  }

  async function renderHistory(){
    try {
      const nftsSnapshot = await db.ref('nfts').once('value');
      const nfts = nftsSnapshot.val() || [];
      const historyDiv = document.getElementById('history');
      historyDiv.innerHTML = '';
      const adminNfts = nfts.filter(n => n.owner === 'admin');
      adminNfts.forEach(nft => {
        const div = document.createElement('div');
        div.className = 'nft';
        div.innerHTML = `
          <img src="${nft.image}" alt="img"/>
          <div>
            <b>${nft.title}</b><br/>
            Код: ${nft.code}<br/>
            Цена: ${nft.price} STAR<br/>
            Редкость: ${nft.rarity}
          </div>
        `;
        historyDiv.appendChild(div);
      });
    } catch(e){
      console.error('Ошибка загрузки истории:', e);
    }
  }

  document.getElementById('createNFTBtn').addEventListener('click', addModel);
  document.getElementById('changeBalanceBtn').addEventListener('click', changeBalance);

  renderHistory();

</script>
</body>
</html>

