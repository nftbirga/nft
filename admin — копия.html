<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Админка NFT</title>
  <style>
    body { font-family: sans-serif; background: #eef4fb; padding: 20px; color: #000; }
    input, select, button { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; }
    .nft { background: #fff; border-radius: 8px; padding: 10px; margin-top: 10px; box-shadow: 0 0 5px #aaa; }
    img { border-radius: 6px; width: 100%; }
  </style>
</head>
<body>

<h1>Админка: создать NFT-модель</h1>

<input id="title" placeholder="Название модели">
<input id="image" placeholder="URL изображения">
<input id="price" placeholder="Цена по умолчанию (STAR)">
<select id="rarity">
  <option>Выбери редкость</option>
  <option value="0.01%">0.01%</option>
  <option value="0.1%">0.1%</option>
  <option value="0.5%">0.5%</option>
  <option value="1%">1%</option>
  <option value="2%">2%</option>
  <option value="3%">3%</option>
  <option value="4%">4%</option>
  <option value="5%">5%</option>
  <option value="tested">tested</option>
  <option value="error">error</option>
</select>
<input id="quantity" type="number" placeholder="Сколько NFT выпустить">
<button onclick="addModel()">Создать NFT</button>

<h2>Пополнить пользователю баланс</h2>
<input id="userLogin" placeholder="Логин пользователя">
<input id="amountToAdd" placeholder="Сколько STAR пополнить">
<button onclick="addBalance()">Пополнить</button>

<h2>Последние NFT (можно удалить)</h2>
<div id="history"></div>

<h2>Пользователи</h2>
<ul id="userList"></ul>

<script>
function generateNFTCode(title, index) {
  const num = String(index + 1).padStart(12, '0');
  // буквы 'aa' для всех (можно заменить на уникальные позже)
  return num + 'aa';
}

function addModel() {
  const title = document.getElementById('title').value.trim();
  const image = document.getElementById('image').value.trim();
  const price = document.getElementById('price').value.trim();
  const rarity = document.getElementById('rarity').value;
  const quantity = parseInt(document.getElementById('quantity').value);

  if (!title || !image || !price || !rarity || !quantity || quantity <= 0) {
    alert('Заполните все поля');
    return;
  }

  // Загружаем модели и NFT
  let models = JSON.parse(localStorage.getItem('nftModels')) || [];
  let nfts = JSON.parse(localStorage.getItem('nfts')) || [];

  // Добавляем модель, если новой названия ещё не было
  if (!models.find(m => m.title === title)) {
    models.push({ title, image, price, rarity, system: "extem beta" });
    localStorage.setItem('nftModels', JSON.stringify(models));
  }

  // Храним индивидуальные счётчики по названию
  let modelCounters = JSON.parse(localStorage.getItem('modelCounters')) || {};
  if (!modelCounters[title]) modelCounters[title] = 0;

  // Создаём NFT
  for (let i = 0; i < quantity; i++) {
    const index = modelCounters[title]++;
    const code = generateNFTCode(title, index);
    const id = Date.now() + Math.floor(Math.random() * 10000);
    nfts.push({ id, code, image, title, price, rarity, system: "extem beta", owner: 'admin', forSale: false, createdAt: Date.now() });
  }

  localStorage.setItem('nfts', JSON.stringify(nfts));
  localStorage.setItem('modelCounters', JSON.stringify(modelCounters));
  renderHistory();
}

function renderHistory() {
  const nfts = JSON.parse(localStorage.getItem('nfts')) || [];
  const recent = nfts.sort((a, b) => b.createdAt - a.createdAt).slice(0, 20);
  const div = document.getElementById('history');
  div.innerHTML = recent.map(n => `
    <div class="nft">
      <img src="${n.image}">
      <h3>${n.title}</h3>
      <p>Код: ${n.code}</p>
      <p>Цена: ${n.price} STAR</p>
      <p>Редкость: ${n.rarity}</p>
      <p>Владелец: ${n.owner}</p>
      <button onclick="deleteNFT(${n.id})">Удалить NFT</button>
    </div>
  `).join('');
}

function deleteNFT(id) {
  let nfts = JSON.parse(localStorage.getItem('nfts')) || [];
  nfts = nfts.filter(n => n.id !== id);
  localStorage.setItem('nfts', JSON.stringify(nfts));
  renderHistory();
}

function addBalance() {
  const login = document.getElementById('userLogin').value.trim();
  const amount = parseInt(document.getElementById('amountToAdd').value.trim());
  if (!login || isNaN(amount)) {
    alert('Введите логин и сумму');
    return;
  }
  let users = JSON.parse(localStorage.getItem('users')) || {};
  if (!users[login]) users[login] = { password: '', balance: 0 };
  users[login].balance += amount;
  localStorage.setItem('users', JSON.stringify(users));
  alert(`Пополнено ${amount} STAR пользователю ${login}`);
  renderUsers();
}

function renderUsers() {
  const users = JSON.parse(localStorage.getItem('users')) || {};
  const list = Object.keys(users).map(u => `<li>${u}</li>`).join('');
  document.getElementById('userList').innerHTML = list;
}

// Автоматическая очистка старых NFT без id/createdAt
(function cleanBrokenNFTs() {
  let nfts = JSON.parse(localStorage.getItem('nfts')) || [];
  const before = nfts.length;
  nfts = nfts.filter(n => n.id && n.createdAt);
  if (nfts.length !== before) {
    localStorage.setItem('nfts', JSON.stringify(nfts));
    alert(`Удалено устаревших NFT: ${before - nfts.length}`);
  }
})();

renderHistory();
renderUsers();
</script>

</body>
</html>
